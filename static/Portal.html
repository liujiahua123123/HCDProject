<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.30/vue.global.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css"
          crossorigin="anonymous"/>
    <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/utils.js"></script>

    <style>
        @media screen and (min-width: 1201px) {
            #disk-list {
                width: 70%;
                max-width: 70%;
            }

            #disk-actions {
                width: 30%;
                max-width: 30%;
            }

            #disk-management {
                display: flex;
            }

            #disk-actions > .action {
                margin: 15px;
                width: calc(100% - 30px);
            }
        }

        @media screen and (max-width: 1200px) {
            #disk-list {
                width: 100%;
                max-width: 100%;
            }

            #disk-actions {
                width: 100%;
                max-width: 100%;
            }

            #disk-management {
                display: block;
            }

            .action {
                margin-bottom: 15px;
                margin-top: 15px;
                margin-left: 5%;
                width: 90%;
            }
        }

        .tag-list > i {
            margin-left: 3px;
            margin-right: 3px;
        }

        #disk-management {
            font-family: monospace;
        }

    </style>

    <script>
        let hostCollapses = []
        let vm

        function all_selected_disk() {
            let list = []
            $(".disk-checkbox").each(function () {
                if ($(this).prop("checked")) {
                    list[list.length] = {
                        "diskId": $(this).attr("disk_id"),
                        "hostId": $(this).attr("host_id")
                    }
                }
            })
            return list
        }

        function all_selected_host() {
            let list = []
            $(".host-checkbox").each(function () {
                if ($(this).prop("checked")) {
                    list[list.length] = $(this).attr("host_id")
                }
            })
            return list
        }

        function all_selected_cluster() {
            let list = []
            $(".cluster-checkbox").each(function () {
                if ($(this).prop("checked")) {
                    list[list.length] = $(this).attr("cluster_id")
                }
            })
            return list
        }


        function renderHostCollapse() {
            hostCollapses = []

            $(".host-head").each(function () {
                let x = new mdui.Collapse($(this), {});
                x.openAll()
                let id = hostCollapses.length
                $(this).attr("col_id", id)
                hostCollapses[hostCollapses.length] = x
            })

            let open_all_host = $(".open-all-host")
            open_all_host.off("click");
            open_all_host.click(function () {
                let that = $(this)
                $(this).parent().parent().find(".host-head").each(function () {
                    let c = hostCollapses[parseInt($(this).attr("col_id"))]
                    if (that.attr("open") === "open") {
                        c.closeAll()
                    } else {
                        c.openAll()
                    }
                })
                if (that.attr("open") === "open") {
                    that.attr("open", false)
                } else {
                    that.attr("open", "open")
                }
            })


            function onCheckboxUpdate() {
                $(".disk-action").prop("disabled", all_selected_disk().length === 0)
                $(".host-action").prop("disabled", all_selected_host().length === 0)
                $(".cluster-action").prop("disabled", all_selected_cluster().length === 0)
            }

            let checkbox = $('input:checkbox')
            checkbox.off("change")
            checkbox.change(onCheckboxUpdate)

            function onQuickSelectDisks() {
                if ($(this).find("i").html() === "add") {
                    $(this).find("i").html("remove")
                    $(this).parent().parent().find(".disk-checkbox").prop("checked", true)
                } else {
                    $(this).find("i").html("add")
                    $(this).parent().parent().find(".disk-checkbox").prop("checked", false)
                }
                onCheckboxUpdate()
                return false
            }

            let host = $(".host-select-all-disk")
            host.off("click");
            host.click(onQuickSelectDisks)
            let cluster = $(".cluster-select-all-disk")
            cluster.off("click");
            cluster.click(onQuickSelectDisks)
        }

        function vue() {
            const onUpdate = function () {
                console.log("VUE updated")
                mdui.mutation()
                renderHostCollapse()
            }

            const SourceData = {
                data() {
                    return {
                        data: [],
                    }
                },
                methods: {
                    updateData(newData) {
                        this.data = newData
                    }
                },
                updated() {
                    this.$nextTick(function () {
                        onUpdate()
                    })
                }
            }

            app = Vue.createApp(SourceData)
            app.component('disk', {
                props: ['disk_info', 'host_id'],
                template: '#disk-template'
            })
            app.component('host', {
                props: ['host_id', 'host_name', 'disk_data'],
                template: '#host-template'
            })
            app.component('cluster', {
                props: ['cluster_id', 'hosts'],
                template: '#cluster-template'
            })
            vm = app.mount("#disk-management")
            onUpdate()
        }

        function refresh() {
            $("#portal_ip").text(currentPortal())
            document.dataPost("/host/list-by-cluster", {}, function (success, data) {
                vm.updateData(data)
            })
        }

        function currentPortal() {
            var re = /(\d{0,3}[.]){3}(\d{0,3})/

            let x = window.location.href.split("#")[0]
            let z = x.split("/").reverse()
            for (let i = 0; i < z.length; ++i) {
                if (re.test(z[i])) {
                    return z[i]
                }
            }
        }

        $(window).ready(function () {
            vue()
            refresh()
        })


    </script>
</head>

<template id="cluster-template">
    <ul class="mdui-list" style="margin-top: 15px">
        <li class="cluster">
            <div class="mdui-collapse-item-header mdui-list-item">
                <i v-if="cluster_id != null" class="mdui-icon material-icons">&#xe2c2;</i>
                <i v-if="cluster_id == null" class="mdui-icon material-icons">&#xe88b;</i>
                <div class="mdui-list-item-content" style="margin-left: 5px">
                    {{ cluster_id == null ? "Free Hosts (hosts not in any cluster)" : "Cluster " + cluster_id }}
                </div>
                <i open=open class="mdui-collapse-item-arrow mdui-icon material-icons open-all-host">format_align_justify</i>


                <label v-if="cluster_id != null" class="mdui-checkbox">
                    <input class="cluster-checkbox" v-bind:cluster_id="cluster_id" type="checkbox" name="group1"/>
                    <i class="mdui-checkbox-icon"></i>
                </label>

                <label v-if="cluster_id == null" class="mdui-checkbox">
                    <input type="checkbox" name="group1" disabled/>
                    <i class="mdui-checkbox-icon"></i>
                </label>

                <button style="margin-left: 8px"
                        class="mdui-btn mdui-btn-icon mdui-color-theme-accent mdui-btn-dense cluster-select-all-disk">
                    <i class="mdui-icon material-icons">add</i>
                </button>
            </div>

            <host v-for="host in hosts"
                  v-bind:host_id="host.hostId"
                  v-bind:host_name="host.hostName"
                  v-bind:disk_data="host.disks">
            </host>
        </li>
    </ul>
</template>
<template id="host-template">
    <ul class="mdui-list host-head" mdui-collapse="{}">
        <li class="mdui-collapse-item">
            <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
                <i class="mdui-icon material-icons">&#xe2c8;</i>
                <div class="mdui-list-item-content" style="margin-left: 5px">{{ host_id + " (" + host_name + ")" }}
                </div>
                <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
                <label class="mdui-checkbox ">
                    <input class="host-checkbox" v-bind:host_id="host_id" type="checkbox" name="group1"/>
                    <i class="mdui-checkbox-icon"></i>
                </label>
                <button style="margin-left: 8px"
                        class="mdui-btn mdui-btn-icon mdui-color-theme-accent mdui-btn-dense host-select-all-disk">
                    <i class="mdui-icon material-icons">add</i>
                </button>
            </div>
            <ul class="mdui-collapse-item-body mdui-list host">
                <disk v-for="disk_info in disk_data" v-bind:disk_info="disk_info" v-bind:host_id="host_id"></disk>
            </ul>
        </li>
    </ul>
</template>

<template id="disk-template">
    <li class="mdui-list-item disk">
        <i class="mdui-icon material-icons">&#xe53b;</i>
        <div class="mdui-list-item-content" style="margin-left: 5px">
            {{ disk_info.diskId }}
            <span style="margin-left: 10px;margin-right: 10px" class="tag-list">
                                <i v-if="disk_info.diskTagList.includes('DATA_DISK')"
                                   class="mdui-icon material-icons"
                                   mdui-tooltip="{content: 'Data'}">&#xe1af;</i>
                                <i v-if="!disk_info.diskTagList.includes('DATA_DISK')"
                                   class="mdui-icon material-icons" style="opacity: 0">&#xe54e;</i>

                                <i v-if="disk_info.diskTagList.includes('METADATA_DISK')"
                                   class="mdui-icon material-icons"
                                   mdui-tooltip="{content: 'Meta'}">&#xe54e;</i>
                                <i v-if="!disk_info.diskTagList.includes('METADATA_DISK')"
                                   class="mdui-icon material-icons"
                                   style="opacity: 0">&#xe54e;</i>

                                <i v-if="disk_info.diskTagList.includes('WRITE_CACHE')"
                                   class="mdui-icon material-icons"
                                   mdui-tooltip="{content: 'Write'}">&#xe3c9;</i>
                                <i v-if="!disk_info.diskTagList.includes('WRITE_CACHE')"
                                   class="mdui-icon material-icons"
                                   style="opacity: 0">&#xe3c9;</i>

                                <i v-if="disk_info.diskTagList.includes('READ_CACHE')"
                                   class="mdui-icon material-icons"
                                   mdui-tooltip="{content: 'Read Cache'}">&#xe417;</i>
                                <i v-if="!disk_info.diskTagList.includes('READ_CACHE')"
                                   class="mdui-icon material-icons"
                                   style="opacity: 0">&#xe417;</i>
                            </span>
            <i mdui-tooltip="{content: 'Serial Number'}">{{ disk_info.diskSerialNumber }}</i>
            <i style="margin-left: 10px" mdui-tooltip="{content: 'Node Name'}">{{ disk_info.deviceNodeName }}</i>
            <i style="margin-left: 10px" mdui-tooltip="{content: 'Downstream Device'}">{{ disk_info.downstreamDevice
                }}</i>
            <i style="margin-left: 10px"
               mdui-tooltip="{content: 'pciGroup UpstreamBus'}">{{ disk_info.pciGroupUpstreamBus }}</i>
        </div>
        <i v-bind:mdui-tooltip="'{content: \'state: ' + disk_info.state + '<br> physical State:'  + disk_info.physicalState + '<br> mount:' + disk_info.mountPoint +'\'}'"
           class="mdui-icon material-icons">&#xe88e;</i>

        <label class="mdui-checkbox">
            <input type="checkbox" v-bind:disk_tags="disk_info.diskTagList" v-bind:disk_id="disk_info.diskId"
                   v-bind:host_id="host_id" class="disk-checkbox"/>
            <i class="mdui-checkbox-icon"></i>
        </label>
    </li>
</template>


<body class="mdui-theme-layout-dark mdui-theme-primary-amber mdui-theme-accent-orange">

<div class="mdui-toolbar mdui-color-theme">
    <span style="height: 100%">
        <img src="/logo.svg" style="height: 85%;margin-top: 7.5%">
    </span>
    <span class="mdui-typo-title"><b id="portal_ip"></b></span>
    <div class="mdui-toolbar-spacer"></div>
    <div>
        <button class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'Home'}" onclick="window.open('/')">
            <i class="mdui-icon material-icons">&#xe88a;</i>
        </button>
    </div>
</div>


<div id="disk-management" class="mdui-container-fluid">
    <div id="disk-list">
        <cluster v-for="cluster in data" v-bind:cluster_id="cluster.clusterId" v-bind:hosts="cluster.hosts"></cluster>
    </div>

    <div id="disk-actions">
        <div class="mdui-typo">
            <blockquote>
                <footer>
                    Disk Operation
                </footer>
            </blockquote>
        </div>

        <ul class="mdui-menu" id="add-tag-menu">

            <li class="mdui-menu-item">
                <a class="add_tag" tag="DATA_DISK" class="mdui-ripple"><i
                        class="mdui-icon material-icons mdui-menu-item-icon"
                        mdui-tooltip="{content: 'Data'}">&#xe1af;</i>DATA</a>
            </li>
            <li class="mdui-menu-item">
                <a class="add_tag" tag="METADATA_DISK" class="mdui-ripple"><i
                        class="mdui-icon material-icons mdui-menu-item-icon"
                        mdui-tooltip="{content: 'Data'}">&#xe54e;</i>META</a>
            </li>
            <li class="mdui-menu-item">
                <a class="add_tag" tag="WRITE_CACHE" id="add" class="mdui-ripple"><i
                        class="mdui-icon material-icons mdui-menu-item-icon"
                        mdui-tooltip="{content: 'Data'}">&#xe3c9;</i>WRITE</a>
            </li>
            <li class="mdui-menu-item">
                <a class="add_tag" tag="READ_CACHE" class="mdui-ripple"><i
                        class="mdui-icon material-icons mdui-menu-item-icon"
                        mdui-tooltip="{content: 'Data'}">&#xe417;</i>READ</a>
            </li>
            <li class="mdui-divider"></li>
            <li class="mdui-menu-item">
                <a id="add_tag_data_meta" class="mdui-ripple">
                    DATA + META
                </a>
            </li>
        </ul>

        <button class="mdui-btn mdui-btn-block mdui-color-theme-accent mdui-ripple action disk-action" disabled
                mdui-menu="{target: '#add-tag-menu'}">Add Tag
        </button>

        <ul class="mdui-menu" id="remove-tag-menu">
            <li class="mdui-menu-item remove-tag" tag="DATA_DISK">
                <a class="mdui-ripple"><i class="mdui-icon material-icons mdui-menu-item-icon"
                                          mdui-tooltip="{content: 'Data'}">&#xe1af;</i>DATA</a>
            </li>
            <li class="mdui-menu-item remove-tag" tag="METADATA_DISK">
                <a class="mdui-ripple"><i class="mdui-icon material-icons mdui-menu-item-icon"
                                          mdui-tooltip="{content: 'Data'}">&#xe54e;</i>META</a>
            </li>
            <li class="mdui-menu-item remove-tag" tag="WRITE_CACHE">
                <a class="mdui-ripple"><i class="mdui-icon material-icons mdui-menu-item-icon"
                                          mdui-tooltip="{content: 'Data'}">&#xe3c9;</i>WRITE</a>
            </li>
            <li class="mdui-menu-item remove-tag" tag="READ_CACHE">
                <a class="mdui-ripple"><i class="mdui-icon material-icons mdui-menu-item-icon"
                                          mdui-tooltip="{content: 'Data'}">&#xe417;</i>READ</a>
            </li>
        </ul>

        <button class="mdui-btn mdui-btn-block mdui-color-theme-accent mdui-ripple action disk-action" disabled
                mdui-menu="{target: '#remove-tag-menu'}">Remove Tag
        </button>

        <div class="mdui-typo">
            <blockquote>
                <footer>
                    Host Operation
                </footer>
            </blockquote>
        </div>

        <button class="mdui-btn mdui-btn-block mdui-color-theme-accent mdui-ripple action host-action" disabled>Join To
            Cluster
        </button>
        <button class="mdui-btn mdui-btn-block mdui-color-theme-accent mdui-ripple action host-action" disabled>Create
            Cluster With Selected Host
        </button>

        <div class="mdui-typo">
            <blockquote>
                <footer>
                    Cluster Operation
                </footer>
            </blockquote>
        </div>
        <button class="mdui-btn mdui-btn-block mdui-color-theme-accent mdui-ripple action cluster-action" disabled>Save
            Cluster To Template
        </button>
        <button class="mdui-btn mdui-btn-block mdui-color-red mdui-ripple action cluster-action" disabled>CLEAN</button>
        <div class="mdui-typo">
            <blockquote>
                <footer>
                    Global Operation
                </footer>
            </blockquote>
        </div>
        <button class="mdui-btn mdui-btn-block mdui-color-theme-accent mdui-ripple action">Create Cluster From
            Template
        </button>
    </div>
</div>

</body>
</html>